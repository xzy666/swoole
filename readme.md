# 进程相关

### 进程
  - 就是一个正在运行的程序
  - 核心的内容 ： 1.内存 2.上下文环境
  - 多个进程 通过系统函数创建出多个子进程
  - 子进程和父进程一样 有自己的内存空间和上下文环境
  - 子进程复制父进程上下文环境 
  - 修改子进程内存空间，不会修改父进程的内存
  - 父进程创建的IO句柄也会被复制一遍
  - 管道是一组，两个描述符，读写分离，单向通讯
  - 管道必须在fork之前创建
  
  - 主进程退出对子进程的影响
    - 主进程在子进程未结束前退出，子进程会将父进程ID改为1
    - 在子进程结束后会由init进程来回收
  - 线程间的影响
    - 主线程退出后，子线程的状态依赖主线程所在的进程，如果进程没有退出的话子线程依然可以正常的运转。
    - 如果进程退出了，那么它所有的线程都会退出
### 进程间通信
  - 共享内存
    - 创建一块共享内存
    - 不属于任何进程
    - 每个进程都能访问，只要有索引
    - 可以通过方法被创建
    - 进程关闭，共享内存仍然存在
    -ipcs -n 查看共享内存块
  - 管道
  - 消息队列
    - 独立于进程之外的特殊空间，通过key访问
    
### swoole 结构
---------------------------------------
Master  |  Main Reactor                |----|
        |  Reactor Reactor Reactor     |    |
---------------------------------------|    | 管道
Manager                                |    | 
---------------------------------------|    |
Worker | Worker | Worker | Worker      | <--|
---------------------------------------|    |
Task | Task | Task | Task              | <--| 管道、消息队列
---------------------------------------|   

过去依赖nginx+fpm外部服务器和解析器
 fpm在请求时创建进程处理请求再销毁进程
 
Master:主进程
处理swoole核心的事件驱动，拥有若干个reactor线程。
每一个reactor子线程当中，都运行了一个e-poll函数实例。
swoole所有对事件的监听都会在线程中实现
比如来自客户端的连接、异步操作的文件、文件用的描述符都会注册在这些e-poll当中



Manager进程是一个管理进程 创建和管理worker和taskworker
只做进程的管理和分配 不处理业务逻辑

worker 主逻辑进程
tasker 异步工作进程

具体流程：当有一个客户端连接时，首先会被Main Reactor线程接收到，然后将这个连接
的读写操作的监听注册到对应reactor子线程当中，并通知worker进程处理对应的onConnect操作，
当客户端发送数据时，Reactor收到数据通过管道发送给worker进程处理。worker如果需要投递任务，
同样通过管道将数据发送给taskworker进程。Taskwork处理完之后再返回给worker进程。worker进程再发送给reactor，
由reactor发送给客户端。

worker出现意外或者一定的请求次数关闭后，swoole会拉起新的进程。


###TaskWorker
task独立于work的工作进程，处理耗时性逻辑，不影响worker去处理来自客户端的请求，大大提高了请求量
Work 调用task()---->发送数据通知到task进程->task调用监听onTask()处理先关逻辑，然后调用finish()将数据返回给work
这两个进程是通过管道通信的。

Task传递数据的大小 8k 
小于8k就直接通过管道、大于写入临时文件


### IO多路复用
- epoll阻塞
- 监听自己名下的所有描述符
- 本质是阻塞的，能处理大量的socket连接

### event-loop
 - event-loop是一个Reactor线程，会创建一个epoll函数
 - 注册自己的读和写事件
 
 
### process
 - 基于C语言封装的进程管理模块，方便多进程编程
 - 提供了管道，消息队列，